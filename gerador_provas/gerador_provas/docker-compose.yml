version: '3.8'

# ============================================================================
# GERADOR DE PROVAS - Docker Compose
# ============================================================================
# Uso: docker-compose up -d
# Ou use o script: ./script.sh start (Linux/Mac) | .\script.ps1 start (Windows)
# ============================================================================

services:
  # --------------------------------------------------------------------------
  # Aplicação Web (Flask)
  # --------------------------------------------------------------------------
  web:
    build: 
      context: .
      dockerfile: Dockerfile
    container_name: gerador_provas_web
    restart: unless-stopped
    ports:
      - "${PORT:-5000}:5000"
    environment:
      - FLASK_APP=app.py
      - FLASK_ENV=${FLASK_ENV:-development}
      - FLASK_DEBUG=${FLASK_DEBUG:-True}
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key-change-in-production}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-provas_user}:${POSTGRES_PASSWORD:-provas_password_2024}@db:5432/${POSTGRES_DB:-provas_db}
      - HOST=0.0.0.0
      - PORT=5000
      - DIAGRAMAS_DIR=static/diagramas
      - LOG_DIR=logs
      - OUTPUT_DIR=output
      - PDF_OUTPUT_DIR=output/pdf
      - LATEX_OUTPUT_DIR=output/latex
      # CrewAI / LLM (configuração de IA)
      - LLM_PROVIDER=${LLM_PROVIDER:-auto}
      - LLM_MODEL=${LLM_MODEL:-}
      - USE_AI_GENERATION=${USE_AI_GENERATION:-true}
      # API Keys (configure a que você tiver)
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://host.docker.internal:11434}
    volumes:
      # Código fonte (para desenvolvimento com hot-reload)
      - .:/app
      # Persistência de arquivos gerados
      - ./output:/app/output
      - ./static/diagramas:/app/static/diagramas
      - ./logs:/app/logs
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - gerador_network

  # --------------------------------------------------------------------------
  # Banco de Dados (PostgreSQL)
  # --------------------------------------------------------------------------
  db:
    image: postgres:15-alpine
    container_name: gerador_provas_db
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-provas_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-provas_password_2024}
      - POSTGRES_DB=${POSTGRES_DB:-provas_db}
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      # Persistência de dados do PostgreSQL
      - postgres_data:/var/lib/postgresql/data
      # Scripts de inicialização (executados na primeira vez)
      - ./database:/docker-entrypoint-initdb.d:ro
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-provas_user} -d ${POSTGRES_DB:-provas_db}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - gerador_network

  # --------------------------------------------------------------------------
  # Adminer (Interface web para o banco - opcional, para debug)
  # --------------------------------------------------------------------------
  adminer:
    image: adminer:latest
    container_name: gerador_provas_adminer
    restart: unless-stopped
    ports:
      - "8080:8080"
    depends_on:
      - db
    networks:
      - gerador_network
    profiles:
      - debug

# ============================================================================
# Volumes
# ============================================================================
volumes:
  postgres_data:
    name: gerador_provas_postgres_data

# ============================================================================
# Networks
# ============================================================================
networks:
  gerador_network:
    name: gerador_provas_network
    driver: bridge
